<!--
 Copyright 2020 Crown Copyright

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->
# Examples

The Examples module contains all the example specific modules:

- [hr-data-generator](hr-data-generator/README.md), which can create a fake sample dataset based around possible data that a company might hold about its employees.
- example-model, contains the example JVM runners for a SpringBoot application.
- example-library, contains all the deployment agnostic example code such as the rules, types and example configuration for prepopulating the palisade services.
- deployment, contains all the deployment specific code and scripts.

The example demonstrates different users querying an avro file over a REST api.
The queried file is a generated HR dataset of Employee records, generated by the hr-data-generator.md.


## HR Data Generator
The hr-data-generator supplies a synthetic set of data, constructing a number of `Employee` objects with the following fields:
```
class Employee {
    UserId uid;
    String name;
    String dateOfBirth;
    PhoneNumber[] contactNumbers;
    EmergencyContact[] emergencyContacts;
    Address address;
    BankDetails bankDetails;
    String taxCode;
    Nationality nationality;
    Manager[] manager;
    String hireDate;
    Grade grade;
    Department department;
    int salaryAmount;
    int salaryBonus;
    WorkLocation workLocation;
    Sex sex;
}
```
The manager field is an array of manager, which could potentially be nested several layers deep, in the generated example manager is nested 3-5 layers deep.


## Example Library

The users, resources and policies to be used in the example are configured in the [configuration yaml](/example-library/src/main/resources/application-example.yaml).
Each of these prepopulation vaules are loaded into the appropriate service on service start-up, see the [run-example scripts](/deployment/local-jvm/bash-scripts).

In particular, the example deals with the following users:
- User Alice has the role HR and completed the PAYROLL_TRAINING_COURSE
- User Bob has the role ESTATES and not completed any training
- User Eve has the role IT and not completed any training

### BankDetailsRule  
The bankDetails field should be returned:
- if the user querying the file has the HR role, completed the PAYROLL_TRAINING_COURSE and the purpose of the query is SALARY

In all other cases the bankDetails field should be redacted.

### DutyOfCareRule  
This rule is concerned with the contactNumber, emergencyContacts and sex fields. These fields should be returned:
- if the user querying the file has the HR role and the purpose of the query is DUTY_OF_CARE
- if the user querying the file is the line manager of the Employee record being queried and the purpose of the query is DUTY_OF_CARE  

In all other cases these fields should be redacted.

### FirstResourceRule  
This rule is concerned with the resource file that is being requested:
- if the user has an HR role they will be able to access the first resource file

In all other cases the first resource will not be returned to the user.

### NationalityRule  
The nationality field should be returned:
- if the user querying the file has the HR role and the purpose of the query is STAFF_REPORT

In all other cases the nationality field should be redacted.

### RecordMaskingRule
This rule is concerned with the full record:
- if the user querying the file has the HR role then no modifications are made to the record
- if the user is in the management tree of the employee then no modifications are made to the record
- if the user querying the file has the ESTATES role then the DateOfBirth, HireDate, Grade and Manager fields are redacted  

In all other cases the record will have no information returned.

### ZipCodeMaskingRule
This rule is concerned with the address field:
- if the user querying the file has the HR role then the whole address is returned
- if the purpose of the query is DUTY_OF_CARE and the user querying the file is the line manager of the Employee record being queried then the whole address is returned
- if the user querying the file has the ESTATES role then the address field should be returned with the zipcode/postcode masked to reduce its precision

In all other cases the address field should be redacted.

## Example Model

### Rest Example
The example runs the [uk.gov.gchq.palisade.example.runner.RestExample class](/example-model/src/main/java/uk/gov/gchq/palisade/example/runner/RestExample.java) which executes several different queries by the different users, with different purposes.
When you run the example you will see the data has been redacted in line with the policy set out in the rules above.

For deployment specific instructions on how to run the example see:  
- [Local JVM](deployment/local-jvm/README.md) - Runs the example in separate JVMs on the local machine 
- [Local Kubernetes](deployment/local-k8s/README.md) - Runs the example in Kubernetes on the local machine

### Bulk Retrieval Test (developer/maintenance only)

There is a test script built into the deployment directory for testing how many resources Palisade can retrieve in one request
without experiencing an error. This is intended for developers and maintainers of Palisade only.

This script will create the given number of files in a data directory (while backing up the original one) and then trying to
send one request to retrieve all the resources in that directory.

To run it:

1. Compile the code:
    ```bash
    mvn clean install
    ```

1.  Launch the services:
    ```bash
      ./deployment/local-jvm/bash-scripts/startServices.sh
    ```

1. From a separate terminal run the launch script:

    ```bash
    ./example/deployment/local-jvm/bash-scripts/attemptBulkTest.sh <number of resources>
    ```
